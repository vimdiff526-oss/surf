<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>超ゆる楽天テスト | SEA LIFE HUB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="超ゆる検索でまずは表示されることを確認するテストページ" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .wrap{max-width:980px;margin:24px auto;padding:0 16px;}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 16px;}
    input,button{padding:10px;border-radius:8px;border:none}
    button{background:rgba(255,255,255,0.15);cursor:pointer}
    button:hover{background:rgba(255,255,255,0.25)}
    .items-grid{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)}
    @media (max-width:960px){.items-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.items-grid{grid-template-columns:1fr}}
    .card img{height:200px;object-fit:cover}
    .skeleton{background:linear-gradient(90deg,rgba(255,255,255,.08),rgba(255,255,255,.18),rgba(255,255,255,.08));background-size:200% 100%;animation:shine 1.2s linear infinite;height:200px;border-radius:12px}
    @keyframes shine{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .mini{opacity:.85}
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="logo">🌊 SEA LIFE HUB</a>
  </header>
  <div class="header-spacer"></div>

  <main class="wrap">
    <h1 class="section-title">楽天 超ゆる表示テスト</h1>
    <p class="mini">※とりあえずアイテムが出ることの確認用。売切や画像なしも含めて広く拾います。</p>

    <div class="row">
      <input id="kw" type="text" placeholder="キーワード（空でもOK） 例：サーフボード ツイン" style="min-width:260px;flex:1" />
      <input id="min" type="number" placeholder="最小価格" min="0" step="1000" style="width:120px" />
      <input id="max" type="number" placeholder="最大価格" min="0" step="1000" style="width:120px" />
      <button id="go">超ゆる検索</button>
    </div>

    <div id="info" class="mini"></div>
    <div id="grid" class="items-grid" style="margin-top:12px"></div>
  </main>

  <script>
    const API = `${location.origin}/api/rakuten_loose`;

    function placeholder(img){
      return img || 'images/diagnosis.jpg';
    }

    function skeletons(n=6){
      return Array.from({length:n}).map(()=>'<div class="skeleton"></div>').join('');
    }

    async function search(){
      const kw = document.getElementById('kw').value.trim();
      const min = document.getElementById('min').value.trim();
      const max = document.getElementById('max').value.trim();
      const grid = document.getElementById('grid');
      const info = document.getElementById('info');
      grid.innerHTML = skeletons(6);
      info.textContent = '検索中…';

      const sp = new URLSearchParams();
      if(kw) sp.set('keyword', kw);
      if(min) sp.set('minPrice', String(min));
      if(max) sp.set('maxPrice', String(max));

      try{
        const r = await fetch(`${API}?${sp.toString()}`);
        const ct = r.headers.get('content-type') || '';
        if(!ct.includes('application/json')) throw new Error(`非JSON応答: ${r.status} ${r.statusText} / ${ct}`);
        const data = await r.json();
        info.innerHTML = `使用キーワード：<code>${data.usedKeyword || kw || '(デフォルト)'}</code> ／ 件数：<strong>${data.count}</strong>`;
        if(!data.items || !data.items.length){
          grid.innerHTML = '<p class="mini">0件でした。キーワードをもっと広くするか、価格指定を外してお試しください。</p>';
          return;
        }
        grid.innerHTML = data.items.map(x => `
          <article class="card">
            <img src="${placeholder(x.image)}" alt="${x.name}">
            <div class="card-body">
              <h3 style="font-size:1rem;margin:0 0 6px">${x.name}</h3>
              <p class="mini">${x.shop || ''}</p>
              <p><strong>¥${Number(x.price).toLocaleString()}</strong></p>
              <a class="btn link" target="_blank" href="${x.url}">商品ページへ</a>
            </div>
          </article>
        `).join('');
      }catch(e){
        info.textContent = `エラー: ${String(e)}`;
        grid.innerHTML = '';
      }
    }

    document.getElementById('go').addEventListener('click', search);

    // ページ表示時に一回、キーワード空で実行（最も広い検索）
    window.addEventListener('load', search);
  </script>
</body>
</html>
