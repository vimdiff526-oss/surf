<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰è¨ºæ–­ | SEA LIFE HUB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="åˆå¿ƒè€…å‘ã‘ã€‚çµŒé¨“å›æ•°ã«å¿œã˜ã¦æ¨å¥¨æµ®åŠ›ã‚’è‡ªå‹•èª¿æ•´ã—ã€ã‚¿ã‚¤ãƒ—ãƒ»ã‚µã‚¤ã‚ºç›®å®‰ã¨å€™è£œæ¤œç´¢ã‚’ææ¡ˆã—ã¾ã™ã€‚" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ===== æ—¢å­˜ãƒ•ã‚©ãƒ¼ãƒ /ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
    form#surfForm{ display:grid; gap:12px; max-width:920px; margin:16px auto 0; grid-template-columns:1fr 1fr;
      background: rgba(0,0,0,0.35); padding:16px; border-radius:12px; }
    form#surfForm label{ display:flex; flex-direction:column; gap:6px; font-weight:600; }
    form#surfForm select, form#surfForm input{ padding:10px; border-radius:8px; border:none; }
    .span2{ grid-column:1/-1; }
    .mini{ font-size:.9rem; opacity:.9; }
    .result{ margin-top:20px; display:grid; gap:16px; }
    .result .grid{ display:grid; gap:16px; grid-template-columns:1.2fr 1fr; }
    @media (max-width: 900px){ .result .grid{ grid-template-columns:1fr; } }
    .card img{ height:200px; object-fit: cover; }
    .table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; background:rgba(0,0,0,0.25); }
    .table th,.table td{ padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.1); }
    .table th{ text-align:left; color: var(--c-accent); }
    .providers{ display:grid; gap:12px; grid-template-columns:repeat(2,1fr); }
    @media (max-width:720px){ .providers{ grid-template-columns:1fr; } }
    .prov-card{ background:rgba(255,255,255,0.07); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px; }
    .prov-links{ display:flex; gap:8px; flex-wrap:wrap; }
    .items-grid{ display:grid; gap:12px; grid-template-columns:repeat(3,1fr); }
    @media (max-width:960px){ .items-grid{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){ .items-grid{ grid-template-columns:1fr;} }
    .skeleton{ background:linear-gradient(90deg, rgba(255,255,255,0.08), rgba(255,255,255,0.18), rgba(255,255,255,0.08));
      background-size:200% 100%; animation:shine 1.2s linear infinite; height:200px; border-radius:12px; }
    @keyframes shine{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .error-box{ background:rgba(255,60,60,0.15); border:1px solid rgba(255,60,60,0.35);
      padding:12px; border-radius:10px; margin-top:8px; white-space:pre-wrap; }
    .chip{ display:inline-block; padding:4px 8px; border-radius:9999px; background:rgba(255,255,255,0.12); margin:2px; font-size:.85rem; }

    /* ===== è¨ºæ–­ãƒšãƒ¼ã‚¸ç”¨ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼ˆåŠé€æ˜ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ ===== */
    .hero-diagnosis {
      position: relative;
      min-height: 60vh;
      display: grid;
      place-items: center;
      text-align: center;
      color: #fff;
      background: url('images/diagnosis-hero.jpg') center/cover no-repeat;
    }
    .hero-diagnosis .hero-overlay {
      position: absolute; inset: 0;
      background: rgba(0, 0, 0, 0.45);
    }
    .hero-diagnosis .hero-inner {
      position: relative; z-index: 1;
      max-width: 900px; padding: 0 16px;
    }
    .hero-diagnosis h1 {
      font-size: clamp(28px, 5vw, 48px);
      margin-bottom: 16px;
      color: var(--c-accent, #6ee7ff);
      text-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    .hero-diagnosis p {
      line-height: 1.7; font-size: 1.1rem; opacity: .95;
      text-shadow: 0 1px 4px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="logo">ğŸŒŠ SEA LIFE HUB</a>
    <nav class="site-nav" aria-label="Primary">
      <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
      <div class="dropdown">
        <button class="dropbtn" aria-haspopup="true" aria-expanded="false">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â–¾</button>
        <div class="dropdown-content" role="menu">
          <a href="diagnosis.html" class="is-active" role="menuitem">ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰è¨ºæ–­</a>
          <a href="apparel.html" role="menuitem">ã‚¢ãƒ‘ãƒ¬ãƒ«ï¼ˆTã‚·ãƒ£ãƒ„ï¼‰</a>
          <a href="stays.html" role="menuitem">æµ·æ²¿ã„æ°‘æ³Š</a>
        </div>
      </div>
      <a href="index.html#about">ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</a>
    </nav>
    <button class="hamburger" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã" aria-controls="mobileNav" aria-expanded="false"><span class="bar"></span></button>
  </header>
  <div class="header-spacer"></div>

  <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div class="mobile-nav-backdrop" id="backdrop"></div>
  <nav class="mobile-nav" id="mobileNav" aria-label="Mobile">
    <div class="mobile-title">ğŸŒŠ SEA LIFE HUB</div>
    <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
    <a href="diagnosis.html" class="is-active">ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰è¨ºæ–­</a>
    <a href="apparel.html">ã‚¢ãƒ‘ãƒ¬ãƒ«ï¼ˆTã‚·ãƒ£ãƒ„ï¼‰</a>
    <a href="stays.html">æµ·æ²¿ã„æ°‘æ³Š</a>
    <a href="index.html#about">ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</a>
  </nav>

  <!-- ===== ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼ˆã“ã“ã«ã ã‘ã‚³ãƒ”ãƒ¼ã‚’è¡¨ç¤ºï¼‰ ===== -->
  <section class="hero-diagnosis">
    <div class="hero-overlay"></div>
    <div class="hero-inner">
      <h1>ã‚ãªãŸã«æœ€é©ãªã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰ã‚’ã€ã“ã“ã‹ã‚‰ã€‚</h1>
      <p>
        ã‚µãƒ¼ãƒ•ã‚£ãƒ³ã¯ãŸã æŠ€ã‚’æ±ºã‚ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
        æ³¢ã«ä¹—ã‚Šã€é¢¨ã‚’æ„Ÿã˜ã€å¿ƒåœ°ã‚ˆãã‚¯ãƒ«ãƒ¼ã‚ºã™ã‚‹ã“ã¨ã‚‚ã¾ãŸã‚µãƒ¼ãƒ•ã‚£ãƒ³ã€‚<br>
        è‡ªåˆ†ã‚‰ã—ã„ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¦‹ã¤ã‘ã€ãã®ä¸€æ­©ã‚’è¸ã¿å‡ºã™ãŸã‚ã®ãƒœãƒ¼ãƒ‰é¸ã³ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
      </p>
    </div>
  </section>

  <!-- ===== æœ¬æ–‡ï¼šè¨ºæ–­ãƒ•ã‚©ãƒ¼ãƒ /çµæœãªã© ===== -->
  <section class="overlay">
    <main class="container">
      <h2 class="section-title">ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰è¨ºæ–­ï¼ˆåˆå¿ƒè€…ï½å‘ã‘ï¼šçµŒé¨“å›æ•°ã§èª¿æ•´ï¼‰</h2>

      <form id="surfForm">
        <label>ä½“é‡ï¼ˆkgï¼‰
          <input id="weight" type="number" min="35" max="120" step="1" placeholder="ä¾‹ï¼‰68" required />
        </label>

        <label>çµŒé¨“å›æ•°
          <select id="experience">
            <option value="0-10" selected>0ã€œ10å›ï¼ˆ+5Lï¼‰</option>
            <option value="10-20">10ã€œ20å›ï¼ˆ+3Lï¼‰</option>
            <option value="20+">20å›ä»¥ä¸Šï¼ˆ+0Lï¼‰</option>
          </select>
        </label>

        <label>æ³¢ã‚µã‚¤ã‚º
          <select id="wave">
            <option value="small">å°æ³¢ï¼ˆè†ã€œè…¹ï¼‰</option>
            <option value="mid" selected>ãƒŸãƒ‰ãƒ«ï¼ˆè…°ã€œèƒ¸ï¼‰</option>
            <option value="solid">è‚©ã€œé ­ä»¥ä¸Š</option>
          </select>
        </label>

        <label>ã‚¹ã‚¿ã‚¤ãƒ«
          <select id="style">
            <option value="easy">æœ¬æ•°é‡è¦–</option>
            <option value="maneuver" selected>æŠ€ãƒ»æ©Ÿå‹•æ€§</option>
            <option value="cruise">ã‚¯ãƒ«ãƒ¼ã‚º</option>
          </select>
        </label>

        <label>ä½“åŠ›
          <select id="fitness">
            <option value="low">å¼±ã‚</option>
            <option value="mid" selected>ãµã¤ã†</option>
            <option value="high">å¼·ã‚</option>
          </select>
        </label>

        <!-- ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ–ãƒ¼ã‚¹ãƒˆã¯æ®‹ã™ -->
        <label class="span2"><input id="brandBoost" type="checkbox" /> ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆCI / JS / LOST / DHD / Christenson / Firewire ãªã©ï¼‰</label>

        <div class="span2 mini">
          â€»çµŒé¨“å›æ•°ã«å¿œã˜ã¦æ¨å¥¨æµ®åŠ›ã‚’åŠ ç®—ã—ã¾ã™ï¼ˆ0ã€œ10å›:+5L / 10ã€œ20å›:+3L / 20å›ä»¥ä¸Š:+0Lï¼‰ã€‚<br>
          â€»0ä»¶æ™‚ã¯æ¤œç´¢æ¡ä»¶ã‚’è‡ªå‹•ã§ç·©ã‚ã¾ã™ï¼ˆfield=0 / orFlag=1 ãªã©ï¼‰ã€‚
        </div>

        <button class="btn primary span2" type="button" onclick="diagnose()">è¨ºæ–­ã™ã‚‹</button>
      </form>

      <div id="result" class="result"></div>
      <div id="rakuten" class="container" style="padding-top:0"></div>
    </main>
  </section>

  <footer class="site-footer"><p>Â© <span id="year"></span> SEA LIFE HUB</p></footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const API_BASE = location.origin;

    /* ===== è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆçµŒé¨“å›æ•°ã§æµ®åŠ›åŠ ç®—ï¼‰ ===== */
    function experienceBonusLiters(exp){
      if(exp === '0-10') return 5;
      if(exp === '10-20') return 3;
      return 0; // 20+
    }

    function calcVolume(weight, fitness, exp){
      // ãƒ™ãƒ¼ã‚¹ä¿‚æ•°ã¯â€œä¸­åº¸â€ã® 0.45 ã‚’ä¸­å¿ƒã«ã€ä½“åŠ›ã§ Â±0.03 èª¿æ•´
      let base = 0.45;
      if(fitness==='low') base += 0.03;
      if(fitness==='high') base -= 0.03;
      base = Math.max(0.35, Math.min(0.60, base));

      // ãƒ™ãƒ¼ã‚¹ã®ãƒªãƒƒã‚¿ãƒ¼
      let litersBase = Math.round(weight * base * 10)/10;

      // çµŒé¨“å›æ•°ãƒœãƒ¼ãƒŠã‚¹ï¼ˆåŠ ç®—ï¼‰
      const bonus = experienceBonusLiters(exp);
      let liters = Math.round((litersBase + bonus) * 10) / 10;

      // Â±10% ã®ç›®å®‰ãƒ¬ãƒ³ã‚¸ï¼ˆãƒœãƒ¼ãƒŠã‚¹åŠ ç®—å¾Œã®ä¸­å¿ƒã‹ã‚‰ï¼‰
      const low = Math.round(liters * 0.9 * 10)/10;
      const high = Math.round(liters * 1.1 * 10)/10;

      return { liters, range:[low, high], factor: base, bonus, baseLiters: litersBase };
    }

    function pickBoardType(wave, style, exp){
      // åˆå¿ƒè€…å¯„ã‚Šãƒ¦ãƒ¼ã‚¹ã‚’æƒ³å®šã—ã¦ã€ã‚„ã‚„å®‰å®šç³»ã‚’å„ªå…ˆ
      // çµŒé¨“0-10ã¯å®‰å®šå¯„ã‚Šã€10-20ã¯æ±ç”¨ã€20+ã¯å¥½ã¿ã«å°‘ã—æŒ¯ã‚‹
      const novice = (exp === '0-10');
      const semi   = (exp === '10-20');

      if(style==='cruise') return novice ? {type:'ãƒ­ãƒ³ã‚°/ãƒŸãƒƒãƒ‰', why:'æ—©ã„ãƒ†ã‚¤ã‚¯ã‚ªãƒ•ã§æœ¬æ•°ã‚’ç¢ºä¿'} : {type:'ãƒŸãƒƒãƒ‰/ãƒ­ãƒ³ã‚°', why:'ã‚¯ãƒ«ãƒ¼ã‚ºé‡è¦–ã®å®‰å®šæ„Ÿ'};
      if(style==='maneuver'){
        if(wave==='small') return novice ? {type:'ãƒã‚¤ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚·ãƒ§ãƒ¼ãƒˆ/ãƒ•ã‚£ãƒƒã‚·ãƒ¥', why:'å°æ³¢ã§ã®æ¨é€²åŠ›ã¨å®‰å®š'} : {type:'ãƒ•ã‚£ãƒƒã‚·ãƒ¥/ãƒ„ã‚¤ãƒ³å¯„ã‚Šã‚·ãƒ§ãƒ¼ãƒˆ', why:'å°æ³¢ã§ã®åŠ é€Ÿã¨è»½å¿«ã•'};
        return semi ? {type:'ã‚ªãƒ¼ãƒ«ãƒ©ã‚¦ãƒ³ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆ', why:'æŠ€ã¨èµ°ã‚Šã®ãƒãƒ©ãƒ³ã‚¹'} : (novice ? {type:'ãƒŸãƒƒãƒ‰/ã‚·ãƒ§ãƒ¼ãƒˆ(ã‚„ã‚„ãƒœãƒªãƒ¥ãƒ¼ãƒ å¤šã‚)', why:'å–ã‚Šå›ã—ã¨å®‰å®šã®ä¸¡ç«‹'} : {type:'HPã‚·ãƒ§ãƒ¼ãƒˆ', why:'æ©Ÿå‹•æ€§ãƒ»æ€§èƒ½é‡è¦–'});
      }
      // easyï¼ˆæœ¬æ•°é‡è¦–ï¼‰
      return novice ? {type:'ã‚½ãƒ•ãƒˆãƒœãƒ¼ãƒ‰/ãƒ•ã‚¡ãƒ³', why:'å®‰å®šï¼†æœ¬æ•°ç¢ºä¿'} : {type:'ãƒŸãƒƒãƒ‰ãƒ¬ãƒ³ã‚°ã‚¹', why:'æœ¬æ•°ã¨ãƒ©ã‚¤ãƒ³å–ã‚Šã‚’ä¸¡ç«‹'};
    }

    const sizeTable = {
      'ã‚½ãƒ•ãƒˆãƒœãƒ¼ãƒ‰/ãƒ•ã‚¡ãƒ³':   { len:[7.0, 8.0],   wid:[21.0, 23.0], thick:[2.75, 3.3] },
      'ãƒŸãƒƒãƒ‰ãƒ¬ãƒ³ã‚°ã‚¹':        { len:[6.8, 7.6],   wid:[20.5, 22.5], thick:[2.6, 3.0] },
      'ãƒ­ãƒ³ã‚°/ãƒŸãƒƒãƒ‰':         { len:[9.0, 9.6],   wid:[22.5, 23.5], thick:[2.75, 3.25] },
      'ãƒ•ã‚£ãƒƒã‚·ãƒ¥/ãƒ„ã‚¤ãƒ³å¯„ã‚Šã‚·ãƒ§ãƒ¼ãƒˆ': { len:[5.4, 6.0], wid:[19.5, 21.5], thick:[2.4, 2.7] },
      'ã‚ªãƒ¼ãƒ«ãƒ©ã‚¦ãƒ³ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆ': { len:[5.83, 6.33], wid:[18.5, 20.5], thick:[2.3, 2.6] },
      'ãƒŸãƒƒãƒ‰/ã‚·ãƒ§ãƒ¼ãƒˆ(ã‚„ã‚„ãƒœãƒªãƒ¥ãƒ¼ãƒ å¤šã‚)': { len:[6.0, 6.6], wid:[19.5, 21.5], thick:[2.5, 2.8] },
      'ãƒã‚¤ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚·ãƒ§ãƒ¼ãƒˆ/ãƒ•ã‚£ãƒƒã‚·ãƒ¥': { len:[5.8, 6.4], wid:[19.5, 21.5], thick:[2.5, 2.8] },
      'HPã‚·ãƒ§ãƒ¼ãƒˆ':            { len:[5.8, 6.2],  wid:[18.0, 19.5], thick:[2.25, 2.5] },
      'ãƒ­ãƒ³ã‚°':                { len:[9.0, 9.6],  wid:[22.5, 23.5], thick:[2.75, 3.25] }
    };

    const toFeetInches = (v)=>{ const f=Math.floor(v); const i=Math.round((v-f)*12); return {feet:f,inches:i}; };
    const fmtFeetInches = ({feet,inches}) => `${feet}'${inches}"`;
    const rangeFeetInches = ([a,b])=>{ const A=toFeetInches(a), B=toFeetInches(b); return `${fmtFeetInches(A)} ã€œ ${fmtFeetInches(B)}`; };
    const rangeCm = ([a,b])=>`${Math.round(a*30.48)}ã€œ${Math.round(b*30.48)}cm`;
    const rangeInch = ([a,b])=>`${a.toFixed(2)}ã€œ${b.toFixed(2)}"`;

    function normalizeTypeForQuery(type){
      return type
        .replace('ãƒŸãƒƒãƒ‰/ã‚·ãƒ§ãƒ¼ãƒˆ(ã‚„ã‚„ãƒœãƒªãƒ¥ãƒ¼ãƒ å¤šã‚)','ã‚·ãƒ§ãƒ¼ãƒˆ')
        .replace('ãƒã‚¤ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚·ãƒ§ãƒ¼ãƒˆ/ãƒ•ã‚£ãƒƒã‚·ãƒ¥','ã‚·ãƒ§ãƒ¼ãƒˆ ãƒ•ã‚£ãƒƒã‚·ãƒ¥')
        .replace('ãƒ•ã‚£ãƒƒã‚·ãƒ¥/ãƒ„ã‚¤ãƒ³å¯„ã‚Šã‚·ãƒ§ãƒ¼ãƒˆ','ã‚·ãƒ§ãƒ¼ãƒˆ ãƒ•ã‚£ãƒƒã‚·ãƒ¥ ãƒ„ã‚¤ãƒ³')
        .replace('ãƒ­ãƒ³ã‚°/ãƒŸãƒƒãƒ‰','ãƒ­ãƒ³ã‚° ãƒŸãƒƒãƒ‰')
        .replace('ã‚ªãƒ¼ãƒ«ãƒ©ã‚¦ãƒ³ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆ','ã‚·ãƒ§ãƒ¼ãƒˆ ã‚ªãƒ¼ãƒ«ãƒ©ã‚¦ãƒ³ãƒ‰');
    }

    /* ====== â€œè¶…ã‚†ã‚‹ã‚â€ æ¥½å¤©APIãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ====== */
    function buildRakutenCandidates(type, lenRange, liters, brandBoost){
      const base = `ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰`;
      const t = normalizeTypeForQuery(type);
      const mid = (lenRange[0]+lenRange[1])/2;
      const {feet,inches} = toFeetInches(mid);
      const len = `${feet}'${inches}"`;
      const brands = brandBoost
        ? " ChannelIslands JS LOST DHD Christenson Sharpeye Firewire Pukas HaydenShapes Pyzel"
        : "";
      const NG = "ãƒ•ã‚£ãƒ³ ãƒªãƒ¼ã‚·ãƒ¥ ã‚±ãƒ¼ã‚¹ ãƒ‡ãƒƒã‚­ãƒ‘ãƒƒãƒ‰ ã‚¹ãƒ†ãƒƒã‚«ãƒ¼ ãƒ©ãƒƒã‚¯ ã‚«ãƒãƒ¼ ãƒ¯ãƒƒã‚¯ã‚¹";

      return [
        { kw: `${base} ${t} ${len} ${liters}L${brands}`, p:{ hits: "30", field:"1", orFlag:"0", availability:"1", NGKeyword: NG } },
        { kw: `${base} ${t}${brands}`, p:{ hits: "30", field:"0", orFlag:"0", availability:"1" } },
        { kw: `${base} ã‚·ãƒ§ãƒ¼ãƒˆ ãƒŸãƒƒãƒ‰ ãƒ­ãƒ³ã‚° ãƒ•ã‚£ãƒƒã‚·ãƒ¥${brands}`, p:{ hits:"30", field:"0", orFlag:"1", availability:"1" } },
        { kw: `${base}${brands}`, p:{ hits:"30", field:"0", orFlag:"1", availability:"0" } },
      ];
    }

    async function callRakuten(keyword, params){
      const sp = new URLSearchParams({ keyword, ...params });
      const r = await fetch(`${API_BASE}/api/rakuten?${sp.toString()}`);
      const ct = r.headers.get('content-type') || '';
      if(!ct.includes('application/json')) throw new Error(`éJSONå¿œç­”: ${r.status} ${r.statusText} / ${ct}`);
      return r.json();
    }

    async function renderRakuten(type, lenRange, liters, opts){
      const mount = document.getElementById('rakuten');
      const { brandBoost } = opts;
      const candidates = buildRakutenCandidates(type, lenRange, liters, brandBoost);

      mount.innerHTML = `
        <h2 class="section-title">æ¥½å¤©ã®å€™è£œï¼ˆAPIçµŒç”±ï¼‰</h2>
        <div class="mini" style="margin:-6px 0 8px;">0ä»¶æ™‚ã¯è‡ªå‹•ã§æ¤œç´¢æ¡ä»¶ã‚’ç·©ã‚ã¾ã™ï¼ˆfield=0, orFlag=1 ãªã©ï¼‰ã€‚</div>
        <div class="items-grid">${Array.from({length:6}).map(()=>`<div class="skeleton"></div>`).join('')}</div>
      `;

      let found=null, used=null, usedParams=null;
      for(const c of candidates){
        try{
          const data = await callRakuten(c.kw, c.p);
          if(data.items && data.items.length){ found=data; used=c.kw; usedParams=c.p; break; }
        }catch(_e){ /* æ¬¡ã¸ */ }
      }

      if(!found){
        mount.innerHTML = `
          <h2 class="section-title">æ¥½å¤©ã®å€™è£œï¼ˆ0ä»¶ï¼‰</h2>
          <p class="mini">ä»Šå›ã¯ãƒ’ãƒƒãƒˆã—ã¾ã›ã‚“ã§ã—ãŸã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã•ã‚‰ã«åºƒãã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>
          <div class="mini" style="margin-top:8px;">è©¦è¡Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼š</div>
          <div>${candidates.map(c=>`<span class="chip">${c.kw}</span>`).join('')}</div>
        `;
        return;
      }

      mount.innerHTML = `
        <h2 class="section-title">æ¥½å¤©ã®å€™è£œï¼ˆ${found.count}ä»¶ï¼‰</h2>
        <div class="mini" style="margin:-6px 0 10px;">ä½¿ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼š<code>${used}</code> ï¼ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼š<code>${Object.entries(usedParams).map(([k,v])=>`${k}=${v}`).join('&')}</code></div>
        <div class="items-grid">
          ${found.items.map(x=>`
            <article class="card item-card">
              <img src="${x.image || 'images/diagnosis.jpg'}" alt="${x.name}">
              <div class="card-body">
                <h3>${x.name}</h3>
                <p class="mini">${x.shop || ''}</p>
                <p><strong>Â¥${Number(x.price).toLocaleString()}</strong></p>
                <a class="btn link" target="_blank" href="${x.url}">å•†å“ãƒšãƒ¼ã‚¸ã¸</a>
              </div>
            </article>
          `).join('')}
        </div>
      `;
    }

    /* ===== ãƒªãƒ³ã‚¯æ¤œç´¢ï¼ˆè£œåŠ©ï¼‰ ===== */
    function providerLinks(type, lenRange, liters){
      const enc=encodeURIComponent;
      const t = normalizeTypeForQuery(type);
      const {feet,inches}=toFeetInches((lenRange[0]+lenRange[1])/2);
      const qMain = `ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰ ${t} ${feet}'${inches}" ${liters}L -ãƒªãƒ¼ã‚·ãƒ¥ -ã‚±ãƒ¼ã‚¹`;
      const qAlt  = `ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰ ${t}`;
      return [
        { name:'Amazon', urls:[{label:'æ¤œç´¢',url:`https://www.amazon.co.jp/s?k=${enc(qMain)}`},{label:'ä»£æ›¿',url:`https://www.amazon.co.jp/s?k=${enc(qAlt)}`}]},
        { name:'æ¥½å¤©(ã‚µã‚¤ãƒˆå†…æ¤œç´¢)', urls:[{label:'æ¤œç´¢',url:`https://search.rakuten.co.jp/search/mall/${enc(qMain)}/?st=t&f=0`},{label:'ä»£æ›¿',url:`https://search.rakuten.co.jp/search/mall/${enc(qAlt)}/?st=t&f=0`} ]},
      ];
    }

    function adjustByWeightAndWave(base, weight, wave){
      const bucket = (weight<55)? -1 : (weight<=75)? 0 : 1;
      const waveAdj = (wave==='small')? +0.0 : (wave==='mid')? +0.05 : +0.1;
      const lerpRange = ([min,max], k)=>[ +(min+(max-min)*k).toFixed(2), +(max+(max-min)*k).toFixed(2) ];
      const k = (bucket===-1)? -0.05 : (bucket===1)? 0.05 : 0;
      let len=lerpRange(base.len, k + waveAdj*0.3);
      let wid=lerpRange(base.wid, k*0.8 + waveAdj*0.2);
      let thk=lerpRange(base.thick, k + waveAdj*0.4);
      return {len,wid,thk};
    }

    function diagnose(){
      const weight = Number(document.getElementById('weight').value || 0);
      const experience = document.getElementById('experience').value;
      const wave = document.getElementById('wave').value;
      const style = document.getElementById('style').value;
      const fitness = document.getElementById('fitness').value;
      const brandBoost = document.getElementById('brandBoost').checked;

      if(!weight || weight < 35){ alert('ä½“é‡(kg)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      const vol = calcVolume(weight, fitness, experience);
      const board = pickBoardType(wave, style, experience);
      const base = sizeTable[board.type] || sizeTable['ãƒŸãƒƒãƒ‰ãƒ¬ãƒ³ã‚°ã‚¹'];
      const sized = adjustByWeightAndWave(base, weight, wave);

      const img = (board.type.includes('ãƒ­ãƒ³ã‚°')) ? 'images/stays.jpg'
                : (board.type.includes('ãƒŸãƒƒãƒ‰')) ? 'images/diagnosis.jpg'
                : 'images/apparel.jpg';

      const links = providerLinks(board.type, sized.len, vol.liters);
      const providersHtml = links.map(p=>`
        <div class="prov-card">
          <h4>${p.name}</h4>
          <div class="prov-links">
            ${p.urls.map(u=>`<a class="btn link" target="_blank" href="${u.url}">${u.label}</a>`).join('')}
          </div>
        </div>
      `).join('');

      const html = `
        <div class="grid">
          <article class="card">
            <img src="${img}" alt="${board.type}">
            <div class="card-body">
              <h3>${board.type}</h3>
              <p>${board.why}</p>
              <p class="mini">çµŒé¨“å›æ•°ã«ã‚ˆã‚‹æµ®åŠ›åŠ ç®—: <strong>+${vol.bonus}L</strong>ï¼ˆãƒ™ãƒ¼ã‚¹${vol.baseLiters}L â†’ æ¨å¥¨${vol.liters}Lï¼‰</p>
            </div>
          </article>

          <div>
            <table class="table">
              <thead><tr><th>é …ç›®</th><th>æ¨å¥¨å€¤ï¼ˆç›®å®‰ï¼‰</th></tr></thead>
              <tbody>
                <tr><td>ä½“é‡</td><td>${weight} kg</td></tr>
                <tr><td>çµŒé¨“å›æ•°</td><td>${
                  experience==='0-10'?'0ã€œ10å›':
                  experience==='10-20'?'10ã€œ20å›':'20å›ä»¥ä¸Š'
                }</td></tr>
                <tr><td>æ¨å¥¨ãƒœãƒªãƒ¥ãƒ¼ãƒ </td><td><strong>${vol.liters}â„“</strong>ï¼ˆç´„${vol.range[0]}ã€œ${vol.range[1]}â„“ï¼‰ <span class="mini">ä¿‚æ•°:${vol.factor.toFixed(2)}</span></td></tr>
                <tr><td>é•·ã•</td><td>${rangeFeetInches(sized.len)} <span class="mini">ï¼ˆ${rangeCm(sized.len)}ï¼‰</span></td></tr>
                <tr><td>å¹…</td><td>${rangeInch(sized.wid)}</td></tr>
                <tr><td>åšã¿</td><td>${rangeInch(sized.thk)}</td></tr>
              </tbody>
            </table>

            <h3 style="margin:12px 0 8px;">ä»–ã‚µã‚¤ãƒˆã§æ¢ã™ï¼ˆãƒªãƒ³ã‚¯æ¤œç´¢ï¼‰</h3>
            <div class="providers">${providersHtml}</div>
          </div>
        </div>
      `;
      document.getElementById('result').innerHTML = html;
      window.scrollTo({ top: document.getElementById('result').offsetTop - 20, behavior: 'smooth' });

      // æ¥½å¤©APIï¼ˆè¶…ã‚†ã‚‹ã‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      renderRakuten(board.type, sized.len, vol.liters, { brandBoost });
    }
  </script>
</body>
</html>
