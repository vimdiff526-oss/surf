<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>サーフボード診断 | SEA LIFE HUB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="推奨サイズを計算し、楽天APIで段階的に曖昧検索。field=0, orFlag=1等でヒット率を高めます。" />
  <link rel="stylesheet" href="style.css" />
  <style>
    form#surfForm{ display:grid; gap:12px; max-width:920px; margin:16px auto 0; grid-template-columns:1fr 1fr;
      background: rgba(0,0,0,0.35); padding:16px; border-radius:12px; }
    form#surfForm label{ display:flex; flex-direction:column; gap:6px; font-weight:600; }
    form#surfForm select, form#surfForm input{ padding:10px; border-radius:8px; border:none; }
    .span2{ grid-column:1/-1; }
    .mini{ font-size:.9rem; opacity:.9; }
    .result{ margin-top:20px; display:grid; gap:16px; }
    .result .grid{ display:grid; gap:16px; grid-template-columns:1.2fr 1fr; }
    @media (max-width: 900px){ .result .grid{ grid-template-columns:1fr; } }
    .card img{ height:200px; }
    .table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; background:rgba(0,0,0,0.25); }
    .table th,.table td{ padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.1); }
    .table th{ text-align:left; color: var(--c-accent); }
    .providers{ display:grid; gap:12px; grid-template-columns:repeat(2,1fr); }
    @media (max-width:720px){ .providers{ grid-template-columns:1fr; } }
    .prov-card{ background:rgba(255,255,255,0.07); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px; }
    .prov-links{ display:flex; gap:8px; flex-wrap:wrap; }
    .items-grid{ display:grid; gap:12px; grid-template-columns:repeat(3,1fr); }
    @media (max-width:960px){ .items-grid{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){ .items-grid{ grid-template-columns:1fr;} }
    .skeleton{ background:linear-gradient(90deg, rgba(255,255,255,0.08), rgba(255,255,255,0.18), rgba(255,255,255,0.08));
      background-size:200% 100%; animation:shine 1.2s linear infinite; height:200px; border-radius:12px; }
    @keyframes shine{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .error-box{ background:rgba(255,60,60,0.15); border:1px solid rgba(255,60,60,0.35);
      padding:12px; border-radius:10px; margin-top:8px; white-space:pre-wrap; }
    .chip{ display:inline-block; padding:4px 8px; border-radius:9999px; background:rgba(255,255,255,0.12); margin:2px; font-size:.85rem; }
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="logo">🌊 SEA LIFE HUB</a>
    <nav class="site-nav" aria-label="Primary">
      <a href="index.html">ホーム</a>
      <div class="dropdown">
        <button class="dropbtn" aria-haspopup="true" aria-expanded="false">メニュー ▾</button>
        <div class="dropdown-content" role="menu">
          <a href="diagnosis.html" class="is-active" role="menuitem">サーフボード診断</a>
          <a href="apparel.html" role="menuitem">アパレル（Tシャツ）</a>
          <a href="stays.html" role="menuitem">海沿い民泊</a>
        </div>
      </div>
      <a href="index.html#about">このサイトについて</a>
    </nav>
    <button class="hamburger" aria-label="メニューを開く" aria-controls="mobileNav" aria-expanded="false"><span class="bar"></span></button>
  </header>
  <div class="header-spacer"></div>

  <div class="mobile-nav-backdrop" id="backdrop"></div>
  <nav class="mobile-nav" id="mobileNav" aria-label="Mobile">
    <div class="mobile-title">🌊 SEA LIFE HUB</div>
    <a href="index.html">ホーム</a>
    <a href="diagnosis.html" class="is-active">サーフボード診断</a>
    <a href="apparel.html">アパレル（Tシャツ）</a>
    <a href="stays.html">海沿い民泊</a>
    <a href="index.html#about">このサイトについて</a>
  </nav>

  <section class="overlay">
    <main class="container">
<section class="intro" style="text-align:center; max-width:800px; margin:0 auto 32px;">
  <h1 style="font-size:2rem; margin-bottom:12px; color:var(--c-accent);">
    あなたに最適なサーフボードを、ここから。
  </h1>
  <p style="line-height:1.7; font-size:1.05rem; opacity:.95;">
    サーフィンはただ技を決めるためのものではありません。<br>
    波に乗り、風を感じ、心地よくクルーズすることもまたサーフィン。<br>
    自分らしいスタイルを見つけ、その一歩を踏み出すためのボード選びをサポートします。
  </p>
</section>

      <h1 class="section-title">サーフボード診断 + 楽天アイテム（超ゆるめフォールバック）</h1>

      <form id="surfForm">
        <label>体重（kg）<input id="weight" type="number" min="35" max="120" step="1" placeholder="例）68" required /></label>
        <label>レベル
          <select id="level"><option value="beginner">初心者</option><option value="intermediate" selected>中級</option><option value="advanced">上級</option></select>
        </label>
        <label>波サイズ
          <select id="wave"><option value="small">小波（膝〜腹）</option><option value="mid" selected>ミドル（腰〜胸）</option><option value="solid">肩〜頭以上</option></select>
        </label>
        <label>スタイル
          <select id="style"><option value="easy">本数重視</option><option value="maneuver" selected>技・機動性</option><option value="cruise">クルーズ</option></select>
        </label>
        <label>体力
          <select id="fitness"><option value="low">弱め</option><option value="mid" selected>ふつう</option><option value="high">強め</option></select>
        </label>
        <label>浮力の好み
          <select id="floatPref"><option value="more">やや多め</option><option value="neutral" selected>ふつう</option><option value="less">やや少なめ</option></select>
        </label>

        <label>価格（最小・円）<input id="minPrice" type="number" min="0" step="1000" placeholder="例）10000" /></label>
        <label>価格（最大・円）<input id="maxPrice" type="number" min="0" step="1000" placeholder="例）150000" /></label>

        <label class="span2"><input id="brandBoost" type="checkbox" /> ブランドブースト（CI / JS / LOST / DHD / Christenson / Firewire など）</label>

        <div class="span2 mini">※0件時は <code>field=0</code> や <code>orFlag=1</code> を使って徐々に緩めます。最終段は売切も含めて候補表示します。</div>

        <button class="btn primary span2" type="button" onclick="diagnose()">診断する</button>
      </form>

      <div id="result" class="result"></div>
      <div id="rakuten" class="container" style="padding-top:0"></div>
    </main>
  </section>

  <footer class="site-footer"><p>© <span id="year"></span> SEA LIFE HUB</p></footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const API_BASE = location.origin;

    /* ===== 診断ロジック（簡略） ===== */
    function calcVolume(weight, level, fitness, floatPref){
      let base = (level==='beginner')?0.50:(level==='advanced')?0.40:0.45;
      if(fitness==='low') base += 0.03; if(fitness==='high') base -= 0.03;
      if(floatPref==='more') base += 0.02; if(floatPref==='less') base -= 0.02;
      base = Math.max(0.35, Math.min(0.60, base));
      const liters = Math.round(weight * base * 10)/10;
      const low = Math.round(liters * 0.9 * 10)/10;
      const high = Math.round(liters * 1.1 * 10)/10;
      return { liters, range:[low, high], factor: base };
    }
    function pickBoardType(level, wave, style){
      if(level==='beginner'){
        if(style==='maneuver' && wave!=='small') return {type:'オールラウンドショート', why:'上達を見据えつつ取り回しやすい'};
        if(style==='cruise') return {type:'ロング/ミッド', why:'早いテイクオフでクルーズ'};
        return {type:'ソフトボード/ファン', why:'安定＆本数確保'};
      }
      if(level==='intermediate'){
        if(style==='maneuver') return (wave==='small')?{type:'フィッシュ/ツイン寄りショート', why:'小波で加速'}:{type:'オールラウンドショート', why:'技と走りのバランス'};
        if(style==='cruise') return {type:'ミッド/ロング', why:'本数とライン取り'};
        return {type:'ミッド/ショート(ややボリューム多め)', why:'取り回しと安定の中庸'};
      }
      if(style==='cruise') return {type:'ロング', why:'大きいラインでクルーズ'};
      return (wave==='small')?{type:'ハイボリュームショート/フィッシュ', why:'小波でも推進力'}:{type:'HPショート', why:'機動性・性能重視'};
    }
    const sizeTable = {
      'ソフトボード/ファン':   { len:[7.0, 8.0],   wid:[21.0, 23.0], thick:[2.75, 3.3] },
      'ミッドレングス':        { len:[6.8, 7.6],   wid:[20.5, 22.5], thick:[2.6, 3.0] },
      'ロング/ミッド':         { len:[9.0, 9.6],   wid:[22.5, 23.5], thick:[2.75, 3.25] },
      'フィッシュ/ツイン寄りショート': { len:[5.4, 6.0], wid:[19.5, 21.5], thick:[2.4, 2.7] },
      'オールラウンドショート': { len:[5.83, 6.33], wid:[18.5, 20.5], thick:[2.3, 2.6] },
      'ミッド/ショート(ややボリューム多め)': { len:[6.0, 6.6], wid:[19.5, 21.5], thick:[2.5, 2.8] },
      'ハイボリュームショート/フィッシュ': { len:[5.8, 6.4], wid:[19.5, 21.5], thick:[2.5, 2.8] },
      'HPショート':            { len:[5.8, 6.2],  wid:[18.0, 19.5], thick:[2.25, 2.5] },
      'ロング':                { len:[9.0, 9.6],  wid:[22.5, 23.5], thick:[2.75, 3.25] }
    };
    const toFeetInches = (v)=>{ const f=Math.floor(v); const i=Math.round((v-f)*12); return {feet:f,inches:i}; };
    const fmtFeetInches = ({feet,inches}) => `${feet}'${inches}"`;
    const rangeFeetInches = ([a,b])=>{ const A=toFeetInches(a), B=toFeetInches(b); return `${fmtFeetInches(A)} 〜 ${fmtFeetInches(B)}`; };
    const rangeCm = ([a,b])=>`${Math.round(a*30.48)}〜${Math.round(b*30.48)}cm`;
    const rangeInch = ([a,b])=>`${a.toFixed(2)}〜${b.toFixed(2)}"`;

    function normalizeTypeForQuery(type){
      return type
        .replace('ミッド/ショート(ややボリューム多め)','ショート')
        .replace('ハイボリュームショート/フィッシュ','ショート フィッシュ')
        .replace('フィッシュ/ツイン寄りショート','ショート フィッシュ ツイン')
        .replace('ロング/ミッド','ロング ミッド')
        .replace('オールラウンドショート','ショート オールラウンド');
    }

    /* ====== “超ゆるめ” 楽天APIフォールバック ======
      段階ごとに (keyword, params) を変えて最大ヒットを狙います。
      - field=0（広い検索）
      - orFlag=1（OR検索）
      - availability=0（売切含む）
      - NGKeyword は厳しい段階のみで軽く使用（フィン等を除外）
    */
    function buildRakutenCandidates(type, lenRange, liters, brandBoost){
      const base = `サーフボード`;
      const t = normalizeTypeForQuery(type);
      const mid = (lenRange[0]+lenRange[1])/2;
      const {feet,inches} = toFeetInches(mid);
      const len = `${feet}'${inches}"`;
      const brands = brandBoost
        ? " ChannelIslands JS LOST DHD Christenson Sharpeye Firewire Pukas HaydenShapes Pyzel"
        : "";

      // NGKeyword は最初だけ軽く（アクセサリ除外）。後半は付けない＝ヒット最優先
      const NG = "フィン リーシュ ケース デッキパッド ステッカー ラック カバー ワックス";

      return [
        // 1) かなり絞る（命中時は精度高め）
        { kw: `${base} ${t} ${len} ${liters}L${brands}`, p:{ hits: "30", field:"1", orFlag:"0", availability:"1", NGKeyword: NG } },

        // 2) 長さ/Lを外して少し緩める
        { kw: `${base} ${t}${brands}`, p:{ hits: "30", field:"0", orFlag:"0", availability:"1" } },

        // 3) OR検索で語彙をばらす（種別語も展開）
        { kw: `${base} ショート ミッド ロング フィッシュ${brands}`, p:{ hits:"30", field:"0", orFlag:"1", availability:"1" } },

        // 4) 最ゆる（まず“ボードらしきもの”を拾う）※売切含む
        { kw: `${base}${brands}`, p:{ hits:"30", field:"0", orFlag:"1", availability:"0" } },
      ];
    }

    async function callRakuten(keyword, params, minPrice, maxPrice){
      const sp = new URLSearchParams({ keyword, ...params });
      if(minPrice) sp.set("minPrice", String(minPrice));
      if(maxPrice) sp.set("maxPrice", String(maxPrice));
      const r = await fetch(`${API_BASE}/api/rakuten?${sp.toString()}`);
      const ct = r.headers.get('content-type') || '';
      if(!ct.includes('application/json')) throw new Error(`非JSON応答: ${r.status} ${r.statusText} / ${ct}`);
      return r.json();
    }

    async function renderRakuten(type, lenRange, liters, opts){
      const mount = document.getElementById('rakuten');
      const { minPrice, maxPrice, brandBoost } = opts;
      const candidates = buildRakutenCandidates(type, lenRange, liters, brandBoost);

      mount.innerHTML = `
        <h2 class="section-title">楽天の候補（API経由）</h2>
        <div class="mini" style="margin:-6px 0 8px;">0件時は自動で検索条件を緩めます（field=0, orFlag=1 など）。</div>
        <div class="items-grid">${Array.from({length:6}).map(()=>`<div class="skeleton"></div>`).join('')}</div>
      `;

      let found=null, used=null, usedParams=null;
      for(const c of candidates){
        try{
          const data = await callRakuten(c.kw, c.p, minPrice, maxPrice);
          if(data.items && data.items.length){ found=data; used=c.kw; usedParams=c.p; break; }
        }catch(_e){ /* スルー（次の候補へ） */ }
      }

      if(!found){
        mount.innerHTML = `
          <h2 class="section-title">楽天の候補（0件）</h2>
          <p class="mini">今回はヒットしませんでした。キーワードをさらに広くするか、価格帯を広げてお試しください。</p>
          <div class="mini" style="margin-top:8px;">試行キーワード：</div>
          <div>${candidates.map(c=>`<span class="chip">${c.kw}</span>`).join('')}</div>
        `;
        return;
      }

      mount.innerHTML = `
        <h2 class="section-title">楽天の候補（${found.count}件）</h2>
        <div class="mini" style="margin:-6px 0 10px;">使用キーワード：<code>${used}</code> ／ パラメータ：<code>${Object.entries(usedParams).map(([k,v])=>`${k}=${v}`).join('&')}</code>${(minPrice||maxPrice)?` ／ 価格: <code>${minPrice||0}〜${maxPrice||'上限なし'}</code>`:''}</div>
        <div class="items-grid">
          ${found.items.map(x=>`
            <article class="card item-card">
              <img src="${x.image || 'images/diagnosis.jpg'}" alt="${x.name}">
              <div class="card-body">
                <h3>${x.name}</h3>
                <p class="mini">${x.shop}</p>
                <p><strong>¥${Number(x.price).toLocaleString()}</strong></p>
                <a class="btn link" target="_blank" href="${x.url}">商品ページへ</a>
              </div>
            </article>
          `).join('')}
        </div>
      `;
    }

    /* ===== リンク検索（補助） ===== */
    function providerLinks(type, lenRange, liters){
      const enc=encodeURIComponent;
      const t = normalizeTypeForQuery(type);
      const {feet,inches}=toFeetInches((lenRange[0]+lenRange[1])/2);
      const qMain = `サーフボード ${t} ${feet}'${inches}" ${liters}L -リーシュ -ケース`;
      const qAlt  = `サーフボード ${t}`;
      return [
        { name:'Amazon', urls:[{label:'検索',url:`https://www.amazon.co.jp/s?k=${enc(qMain)}`},{label:'代替',url:`https://www.amazon.co.jp/s?k=${enc(qAlt)}`}]},
        { name:'楽天(サイト内検索)', urls:[{label:'検索',url:`https://search.rakuten.co.jp/search/mall/${enc(qMain)}/?st=t&f=0`},{label:'代替',url:`https://search.rakuten.co.jp/search/mall/${enc(qAlt)}/?st=t&f=0`} ]},
      ];
    }

    function adjustByWeightAndWave(base, weight, wave){
      const bucket = (weight<55)? -1 : (weight<=75)? 0 : 1;
      const waveAdj = (wave==='small')? +0.0 : (wave==='mid')? +0.05 : +0.1;
      const lerpRange = ([min,max], k)=>[ +(min+(max-min)*k).toFixed(2), +(max+(max-min)*k).toFixed(2) ];
      const k = (bucket===-1)? -0.05 : (bucket===1)? 0.05 : 0;
      let len=lerpRange(base.len, k + waveAdj*0.3);
      let wid=lerpRange(base.wid, k*0.8 + waveAdj*0.2);
      let thk=lerpRange(base.thick, k + waveAdj*0.4);
      return {len,wid,thk};
    }

    function diagnose(){
      const weight = Number(document.getElementById('weight').value || 0);
      const level = document.getElementById('level').value;
      const wave = document.getElementById('wave').value;
      const style = document.getElementById('style').value;
      const fitness = document.getElementById('fitness').value;
      const floatPref = document.getElementById('floatPref').value;
      const minPrice = Number(document.getElementById('minPrice').value || 0);
      const maxPrice = Number(document.getElementById('maxPrice').value || 0);
      const brandBoost = document.getElementById('brandBoost').checked;

      if(!weight || weight < 35){ alert('体重(kg)を入力してください'); return; }

      const vol = calcVolume(weight, level, fitness, floatPref);
      const board = pickBoardType(level, wave, style);
      const base = sizeTable[board.type] || sizeTable['ミッドレングス'];
      const sized = adjustByWeightAndWave(base, weight, wave);

      const img = (board.type.includes('ロング')) ? 'images/stays.jpg'
                : (board.type.includes('ミッド')) ? 'images/diagnosis.jpg'
                : 'images/apparel.jpg';

      const links = providerLinks(board.type, sized.len, vol.liters);
      const providersHtml = links.map(p=>`
        <div class="prov-card">
          <h4>${p.name}</h4>
          <div class="prov-links">
            ${p.urls.map(u=>`<a class="btn link" target="_blank" href="${u.url}">${u.label}</a>`).join('')}
          </div>
        </div>
      `).join('');

      const html = `
        <div class="grid">
          <article class="card">
            <img src="${img}" alt="${board.type}">
            <div class="card-body">
              <h3>${board.type}</h3>
              <p>${board.why}</p>
              <p class="mini">※APIは 0件 → 条件を自動で緩めて再検索します（field=0 / orFlag=1 / availability=0 など）。</p>
            </div>
          </article>

          <div>
            <table class="table">
              <thead><tr><th>項目</th><th>推奨値（目安）</th></tr></thead>
              <tbody>
                <tr><td>体重</td><td>${weight} kg</td></tr>
                <tr><td>推奨ボリューム</td><td><strong>${vol.liters}ℓ</strong>（約${vol.range[0]}〜${vol.range[1]}ℓ） <span class="mini">係数:${vol.factor.toFixed(2)}</span></td></tr>
                <tr><td>長さ</td><td>${rangeFeetInches(sized.len)} <span class="mini">（${rangeCm(sized.len)}）</span></td></tr>
                <tr><td>幅</td><td>${rangeInch(sized.wid)}</td></tr>
                <tr><td>厚み</td><td>${rangeInch(sized.thk)}</td></tr>
              </tbody>
            </table>

            <h3 style="margin:12px 0 8px;">他サイトで探す（リンク検索）</h3>
            <div class="providers">${providersHtml}</div>
          </div>
        </div>
      `;
      document.getElementById('result').innerHTML = html;
      window.scrollTo({ top: document.getElementById('result').offsetTop - 20, behavior: 'smooth' });

      // 楽天API（超ゆるめフォールバック）
      renderRakuten(board.type, sized.len, vol.liters, {
        minPrice: minPrice || undefined,
        maxPrice: maxPrice || undefined,
        brandBoost
      });
    }
  </script>
</body>
</html>
