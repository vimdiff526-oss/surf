<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰è¨ºæ–­ | SEA LIFE HUB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="æ¨å¥¨ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ã—ã€æ›–æ˜§æ¤œç´¢ãƒªãƒ³ã‚¯ã¨æ¥½å¤©APIã§å€™è£œã‚’è¡¨ç¤ºã€‚0ä»¶ã§ã‚‚æ®µéšçš„ã«æ¤œç´¢æ¡ä»¶ã‚’ç·©ã‚ã¦å†ãƒˆãƒ©ã‚¤ã—ã¾ã™ã€‚" />
  <link rel="stylesheet" href="style.css" />
  <style>
    form#surfForm{
      display:grid; gap:12px; max-width:920px; margin:16px auto 0; grid-template-columns:1fr 1fr;
      background: rgba(0,0,0,0.35); padding:16px; border-radius:12px;
    }
    form#surfForm label{ display:flex; flex-direction:column; gap:6px; font-weight:600; }
    form#surfForm select, form#surfForm input{ padding:10px; border-radius:8px; border:none; }
    .span2{ grid-column:1/-1; }
    .mini{ font-size:.9rem; opacity:.9; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .result{ margin-top:20px; display:grid; gap:16px; }
    .result .grid{ display:grid; gap:16px; grid-template-columns: 1.2fr 1fr; }
    @media (max-width: 900px){ .result .grid{ grid-template-columns: 1fr; } }
    .card img{ height: 200px; }
    .table{ width:100%; border-collapse: collapse; overflow:hidden; border-radius:12px; background: rgba(0,0,0,0.25); }
    .table th, .table td{ padding:10px 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .table th{ text-align:left; color: var(--c-accent); }
    .badge{ display:inline-block; padding:2px 8px; border-radius:9999px; background: rgba(255,255,255,0.15); font-size:.85rem; }

    /* ãƒ—ãƒ­ãƒã‚¤ãƒ€æ¤œç´¢ã‚«ãƒ¼ãƒ‰ */
    .providers{ display:grid; gap:12px; grid-template-columns: repeat(2, 1fr); }
    @media (max-width:720px){ .providers{ grid-template-columns: 1fr; } }
    .prov-card{ background: rgba(255,255,255,0.07); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px; }
    .prov-card h4{ margin:0; font-size:1rem; color: var(--c-accent); }
    .prov-links{ display:flex; gap:8px; flex-wrap:wrap; }
    .prov-links a{ text-decoration:none; border-radius:10px; padding:8px 10px; background: rgba(255,255,255,0.12); }
    .prov-links a:hover{ background: rgba(255,255,255,0.2); }

    /* æ¥½å¤©ã‚¢ã‚¤ãƒ†ãƒ ã‚°ãƒªãƒƒãƒ‰ */
    .items-grid{ display:grid; gap:12px; grid-template-columns: repeat(3, 1fr); }
    @media (max-width:960px){ .items-grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width:640px){ .items-grid{ grid-template-columns: 1fr; } }
    .item-card .card-body h3{ font-size:1rem; margin:0 0 6px; }
    .skeleton{
      background: linear-gradient(90deg, rgba(255,255,255,0.08), rgba(255,255,255,0.18), rgba(255,255,255,0.08));
      background-size: 200% 100%; animation: shine 1.2s linear infinite;
      height: 200px; border-radius: 12px;
    }
    @keyframes shine { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    .error-box{
      background: rgba(255,60,60,0.15); border: 1px solid rgba(255,60,60,0.35);
      padding:12px; border-radius:10px; margin-top:8px; white-space:pre-wrap;
    }
    .chip{ display:inline-block; padding:4px 8px; border-radius:9999px; background: rgba(255,255,255,0.12); margin:2px; font-size:.85rem; }
  </style>
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="site-header">
    <a href="index.html" class="logo">ğŸŒŠ SEA LIFE HUB</a>
    <nav class="site-nav" aria-label="Primary">
      <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
      <div class="dropdown">
        <button class="dropbtn" aria-haspopup="true" aria-expanded="false">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â–¾</button>
        <div class="dropdown-content" role="menu">
          <a href="diagnosis.html" class="is-active" role="menuitem">ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰è¨ºæ–­</a>
          <a href="apparel.html" role="menuitem">ã‚¢ãƒ‘ãƒ¬ãƒ«ï¼ˆTã‚·ãƒ£ãƒ„ï¼‰</a>
          <a href="stays.html" role="menuitem">æµ·æ²¿ã„æ°‘æ³Š</a>
        </div>
      </div>
      <a href="index.html#about">ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</a>
    </nav>
    <button class="hamburger" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã" aria-controls="mobileNav" aria-expanded="false"><span class="bar"></span></button>
  </header>
  <div class="header-spacer"></div>

  <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div class="mobile-nav-backdrop" id="backdrop"></div>
  <nav class="mobile-nav" id="mobileNav" aria-label="Mobile">
    <div class="mobile-title">ğŸŒŠ SEA LIFE HUB</div>
    <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
    <a href="diagnosis.html" class="is-active">ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰è¨ºæ–­</a>
    <a href="apparel.html">ã‚¢ãƒ‘ãƒ¬ãƒ«ï¼ˆTã‚·ãƒ£ãƒ„ï¼‰</a>
    <a href="stays.html">æµ·æ²¿ã„æ°‘æ³Š</a>
    <a href="index.html#about">ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</a>
  </nav>

  <!-- æœ¬æ–‡ -->
  <section class="overlay">
    <main class="container">
      <h1 class="section-title">ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰è¨ºæ–­ + æ¥½å¤©ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢ï¼‰</h1>

      <form id="surfForm">
        <label>ä½“é‡ï¼ˆkgï¼‰<input id="weight" type="number" min="35" max="120" step="1" placeholder="ä¾‹ï¼‰68" required /></label>
        <label>ãƒ¬ãƒ™ãƒ«
          <select id="level"><option value="beginner">åˆå¿ƒè€…</option><option value="intermediate" selected>ä¸­ç´š</option><option value="advanced">ä¸Šç´š</option></select>
        </label>
        <label>æ³¢ã‚µã‚¤ã‚º
          <select id="wave"><option value="small">å°æ³¢ï¼ˆè†ã€œè…¹ï¼‰</option><option value="mid" selected>ãƒŸãƒ‰ãƒ«ï¼ˆè…°ã€œèƒ¸ï¼‰</option><option value="solid">è‚©ã€œé ­ä»¥ä¸Š</option></select>
        </label>
        <label>ã‚¹ã‚¿ã‚¤ãƒ«
          <select id="style"><option value="easy">æœ¬æ•°é‡è¦–</option><option value="maneuver" selected>æŠ€ãƒ»æ©Ÿå‹•æ€§</option><option value="cruise">ã‚¯ãƒ«ãƒ¼ã‚º</option></select>
        </label>
        <label>ä½“åŠ›
          <select id="fitness"><option value="low">å¼±ã‚</option><option value="mid" selected>ãµã¤ã†</option><option value="high">å¼·ã‚</option></select>
        </label>
        <label>æµ®åŠ›ã®å¥½ã¿
          <select id="floatPref"><option value="more">ã‚„ã‚„å¤šã‚</option><option value="neutral" selected>ãµã¤ã†</option><option value="less">ã‚„ã‚„å°‘ãªã‚</option></select>
        </label>

        <label>ä¾¡æ ¼ï¼ˆæœ€å°ãƒ»å††ï¼‰<input id="minPrice" type="number" min="0" step="1000" placeholder="ä¾‹ï¼‰10000" /></label>
        <label>ä¾¡æ ¼ï¼ˆæœ€å¤§ãƒ»å††ï¼‰<input id="maxPrice" type="number" min="0" step="1000" placeholder="ä¾‹ï¼‰150000" /></label>

        <label class="span2 row">
          <input id="brandBoost" type="checkbox" />
          <span>ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆChannel Islands / JS / LOST / DHD / Christenson ãªã©ã‚’ä»˜ä¸ï¼‰</span>
        </label>

        <div class="span2 mini">
          â€»APIã¯ <code>/api/rakuten</code> ã‚’å©ãã¾ã™ã€‚0ä»¶ãªã‚‰è‡ªå‹•ã§æ¡ä»¶ã‚’å¾ã€…ã«ç·©ã‚ã¦å†æ¤œç´¢ã—ã¾ã™ã€‚
        </div>

        <button class="btn primary span2" type="button" onclick="diagnose()">è¨ºæ–­ã™ã‚‹</button>
      </form>

      <div id="result" class="result"></div>
      <div id="rakuten" class="container" style="padding-top:0"></div>

      <section class="accordion">
        <h2 class="section-title">å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰</h2>
        <div class="acc-item">
          <button class="acc-head"><strong>ãƒ†ãƒ¼ãƒ«å½¢çŠ¶ã®åŸºæœ¬</strong><span class="chev">â–¶</span></button>
          <div class="acc-body">
            <ul>
              <li><strong>ã‚¹ã‚¯ã‚¢ãƒƒã‚·ãƒ¥</strong>ï¼šæ±ç”¨æ€§ãŒé«˜ãåˆ‡ã‚Šè¿”ã—è»½å¿«ã€‚</li>
              <li><strong>ã‚¹ãƒ¯ãƒ­ãƒ¼</strong>ï¼šå°æ³¢ã§ã®ã‚°ãƒªãƒƒãƒ—ã¨ã‚¹ãƒ”ãƒ¼ãƒ‰ã€‚</li>
              <li><strong>ãƒ©ã‚¦ãƒ³ãƒ‰</strong>ï¼šã‚¿ãƒ¼ãƒ³ãŒã‚¹ãƒ ãƒ¼ã‚ºã€‚</li>
              <li><strong>ãƒ”ãƒ³</strong>ï¼šã‚µã‚¤ã‚ºã‚ã‚‹æ³¢ã§ã®ãƒ›ãƒ¼ãƒ«ãƒ‰é‡è¦–ã€‚</li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </section>

  <footer class="site-footer"><p>Â© <span id="year"></span> SEA LIFE HUB</p></footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const API_BASE = location.origin;

    /* ===== è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯ ===== */
    function calcVolume(weight, level, fitness, floatPref){
      let base = (level==='beginner')?0.50:(level==='advanced')?0.40:0.45;
      if(fitness==='low') base += 0.03; if(fitness==='high') base -= 0.03;
      if(floatPref==='more') base += 0.02; if(floatPref==='less') base -= 0.02;
      base = Math.max(0.35, Math.min(0.60, base));
      const liters = Math.round(weight * base * 10)/10;
      const low = Math.round(liters * 0.9 * 10)/10;
      const high = Math.round(liters * 1.1 * 10)/10;
      return { liters, range:[low, high], factor: base };
    }
    function pickBoardType(level, wave, style){
      if(level==='beginner'){
        if(style==='maneuver' && wave!=='small') return {type:'ã‚ªãƒ¼ãƒ«ãƒ©ã‚¦ãƒ³ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆ', why:'ä¸Šé”ã‚’è¦‹æ®ãˆã¤ã¤å–ã‚Šå›ã—ã‚„ã™ã„'};
        if(style==='cruise') return {type:'ãƒ­ãƒ³ã‚°/ãƒŸãƒƒãƒ‰', why:'æ—©ã„ãƒ†ã‚¤ã‚¯ã‚ªãƒ•ã§ã‚¯ãƒ«ãƒ¼ã‚º'};
        return {type:'ã‚½ãƒ•ãƒˆãƒœãƒ¼ãƒ‰/ãƒ•ã‚¡ãƒ³', why:'å®‰å®šï¼†æœ¬æ•°ç¢ºä¿'};
      }
      if(level==='intermediate'){
        if(style==='maneuver') return (wave==='small')?{type:'ãƒ•ã‚£ãƒƒã‚·ãƒ¥/ãƒ„ã‚¤ãƒ³å¯„ã‚Šã‚·ãƒ§ãƒ¼ãƒˆ', why:'å°æ³¢ã§åŠ é€Ÿ'}:{type:'ã‚ªãƒ¼ãƒ«ãƒ©ã‚¦ãƒ³ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆ', why:'æŠ€ã¨èµ°ã‚Šã®ãƒãƒ©ãƒ³ã‚¹'};
        if(style==='cruise') return {type:'ãƒŸãƒƒãƒ‰/ãƒ­ãƒ³ã‚°', why:'æœ¬æ•°ã¨ãƒ©ã‚¤ãƒ³å–ã‚Š'};
        return {type:'ãƒŸãƒƒãƒ‰/ã‚·ãƒ§ãƒ¼ãƒˆ(ã‚„ã‚„ãƒœãƒªãƒ¥ãƒ¼ãƒ å¤šã‚)', why:'å–ã‚Šå›ã—ã¨å®‰å®šã®ä¸­åº¸'};
      }
      if(style==='cruise') return {type:'ãƒ­ãƒ³ã‚°', why:'å¤§ãã„ãƒ©ã‚¤ãƒ³ã§ã‚¯ãƒ«ãƒ¼ã‚º'};
      return (wave==='small')?{type:'ãƒã‚¤ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚·ãƒ§ãƒ¼ãƒˆ/ãƒ•ã‚£ãƒƒã‚·ãƒ¥', why:'å°æ³¢ã§ã‚‚æ¨é€²åŠ›'}:{type:'HPã‚·ãƒ§ãƒ¼ãƒˆ', why:'æ©Ÿå‹•æ€§ãƒ»æ€§èƒ½é‡è¦–'};
    }
    const sizeTable = {
      'ã‚½ãƒ•ãƒˆãƒœãƒ¼ãƒ‰/ãƒ•ã‚¡ãƒ³':   { len:[7.0, 8.0],   wid:[21.0, 23.0], thick:[2.75, 3.3] },
      'ãƒŸãƒƒãƒ‰ãƒ¬ãƒ³ã‚°ã‚¹':        { len:[6.8, 7.6],   wid:[20.5, 22.5], thick:[2.6, 3.0] },
      'ãƒ­ãƒ³ã‚°/ãƒŸãƒƒãƒ‰':         { len:[9.0, 9.6],   wid:[22.5, 23.5], thick:[2.75, 3.25] },
      'ãƒ•ã‚£ãƒƒã‚·ãƒ¥/ãƒ„ã‚¤ãƒ³å¯„ã‚Šã‚·ãƒ§ãƒ¼ãƒˆ': { len:[5.4, 6.0], wid:[19.5, 21.5], thick:[2.4, 2.7] },
      'ã‚ªãƒ¼ãƒ«ãƒ©ã‚¦ãƒ³ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆ': { len:[5.83, 6.33], wid:[18.5, 20.5], thick:[2.3, 2.6] },
      'ãƒŸãƒƒãƒ‰/ã‚·ãƒ§ãƒ¼ãƒˆ(ã‚„ã‚„ãƒœãƒªãƒ¥ãƒ¼ãƒ å¤šã‚)': { len:[6.0, 6.6], wid:[19.5, 21.5], thick:[2.5, 2.8] },
      'ãƒã‚¤ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚·ãƒ§ãƒ¼ãƒˆ/ãƒ•ã‚£ãƒƒã‚·ãƒ¥': { len:[5.8, 6.4], wid:[19.5, 21.5], thick:[2.5, 2.8] },
      'HPã‚·ãƒ§ãƒ¼ãƒˆ':            { len:[5.8, 6.2],  wid:[18.0, 19.5], thick:[2.25, 2.5] },
      'ãƒ­ãƒ³ã‚°':                { len:[9.0, 9.6],  wid:[22.5, 23.5], thick:[2.75, 3.25] }
    };
    function adjustByWeightAndWave(base, weight, wave){
      const bucket = (weight<55)? -1 : (weight<=75)? 0 : 1;
      const waveAdj = (wave==='small')? +0.0 : (wave==='mid')? +0.05 : +0.1;
      const lerpRange = ([min,max], k)=>[ +(min+(max-min)*k).toFixed(2), +(max+(max-min)*k).toFixed(2) ];
      const k = (bucket===-1)? -0.05 : (bucket===1)? 0.05 : 0;
      let len=lerpRange(base.len, k + waveAdj*0.3);
      let wid=lerpRange(base.wid, k*0.8 + waveAdj*0.2);
      let thk=lerpRange(base.thick, k + waveAdj*0.4);
      return {len,wid,thk};
    }

    /* ===== ä¾¿åˆ©é–¢æ•° ===== */
    const toFeetInches = (val)=>{ const f=Math.floor(val); const i=Math.round((val-f)*12); return {feet:f, inches:i}; };
    const fmtFeetInches = ({feet,inches}) => `${feet}'${inches}"`;
    const rangeFeetInches = ([a,b])=>{ const A=toFeetInches(a), B=toFeetInches(b); return `${fmtFeetInches(A)} ã€œ ${fmtFeetInches(B)}`; };
    const rangeCm = ([a,b])=>`${Math.round(a*30.48)}ã€œ${Math.round(b*30.48)}cm`;
    const rangeInch = ([a,b])=>`${a.toFixed(2)}ã€œ${b.toFixed(2)}"`;
    function normalizeTypeForQuery(type){
      return type
        .replace('ãƒŸãƒƒãƒ‰/ã‚·ãƒ§ãƒ¼ãƒˆ(ã‚„ã‚„ãƒœãƒªãƒ¥ãƒ¼ãƒ å¤šã‚)','ã‚·ãƒ§ãƒ¼ãƒˆ')
        .replace('ãƒã‚¤ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚·ãƒ§ãƒ¼ãƒˆ/ãƒ•ã‚£ãƒƒã‚·ãƒ¥','ã‚·ãƒ§ãƒ¼ãƒˆ ãƒ•ã‚£ãƒƒã‚·ãƒ¥')
        .replace('ãƒ•ã‚£ãƒƒã‚·ãƒ¥/ãƒ„ã‚¤ãƒ³å¯„ã‚Šã‚·ãƒ§ãƒ¼ãƒˆ','ã‚·ãƒ§ãƒ¼ãƒˆ ãƒ•ã‚£ãƒƒã‚·ãƒ¥ ãƒ„ã‚¤ãƒ³')
        .replace('ãƒ­ãƒ³ã‚°/ãƒŸãƒƒãƒ‰','ãƒ­ãƒ³ã‚° ãƒŸãƒƒãƒ‰')
        .replace('ã‚ªãƒ¼ãƒ«ãƒ©ã‚¦ãƒ³ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆ','ã‚·ãƒ§ãƒ¼ãƒˆ ã‚ªãƒ¼ãƒ«ãƒ©ã‚¦ãƒ³ãƒ‰');
    }

    /* ===== æ¥½å¤©APIï¼šæ®µéšçš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢ =====
       1) å³ã—ã‚ï¼šã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰ + ç¨®åˆ¥ + é•·ã• + ä½“ç© + ãƒ–ãƒ©ãƒ³ãƒ‰
       2) æ¨™æº– ï¼šã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰ + ç¨®åˆ¥ + ä½“ç© + ãƒ–ãƒ©ãƒ³ãƒ‰
       3) ã‚†ã‚‹ã‚ï¼šã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰ + ç¨®åˆ¥ + ãƒ–ãƒ©ãƒ³ãƒ‰
       4) æœ€å¾Œ   ï¼šã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰ + ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆç¨®åˆ¥ã‚‚å¤–ã™ï¼‰
    */
    function buildRakutenKeywordCandidates(type, lenRange, liters, brandBoost){
      const base = `ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰`;
      const t = normalizeTypeForQuery(type);
      const mid = (lenRange[0]+lenRange[1])/2;
      const {feet,inches} = toFeetInches(mid);
      const len = `${feet}'${inches}"`;

      const brands = brandBoost
        ? ' ChannelIslands JS LOST DHD Christenson Sharpeye Firewire'
        : '';

      return [
        `${base} ${t} ${len} ${liters}L${brands}`,
        `${base} ${t} ${liters}L${brands}`,
        `${base} ${t}${brands}`,
        `${base}${brands}`
      ];
    }

    async function fetchRakuten(keyword, minPrice, maxPrice){
      const p = new URLSearchParams({ keyword, hits:'12' });
      if(minPrice) p.set('minPrice', String(minPrice));
      if(maxPrice) p.set('maxPrice', String(maxPrice));
      const r = await fetch(`${API_BASE}/api/rakuten?${p.toString()}`);
      const ct = r.headers.get('content-type') || '';
      if(!ct.includes('application/json')){
        const txt = await r.text();
        throw new Error(`éJSONå¿œç­”: ${r.status} ${r.statusText} / ${ct}\n${txt.slice(0,200)}`);
      }
      return r.json();
    }

    async function renderRakuten(type, lenRange, liters, opts){
      const mount = document.getElementById('rakuten');
      const { minPrice, maxPrice, brandBoost } = opts;
      const candidates = buildRakutenKeywordCandidates(type, lenRange, liters, brandBoost);

      mount.innerHTML = `
        <h2 class="section-title">æ¥½å¤©ã®å€™è£œï¼ˆAPIçµŒç”±ï¼‰</h2>
        <div class="mini" style="margin:-6px 0 8px;">æ®µéšçš„ã«æ¡ä»¶ã‚’ç·©ã‚ãªãŒã‚‰æ¤œç´¢ã—ã¾ã™ã€‚</div>
        <div class="items-grid">${Array.from({length:6}).map(()=>`<div class="skeleton"></div>`).join('')}</div>
      `;

      let found = null, used = null, errorLog = [];
      for(const kw of candidates){
        try{
          const data = await fetchRakuten(kw, minPrice, maxPrice);
          if(data.items && data.items.length){
            found = data; used = kw; break;
          }
        }catch(e){ errorLog.push(`${kw} â†’ ${String(e)}`); }
      }

      if(!found){
        mount.innerHTML = `
          <h2 class="section-title">æ¥½å¤©ã®å€™è£œï¼ˆ0ä»¶ï¼‰</h2>
          <p class="mini">è©²å½“ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¡ä»¶ã‚’ç·©ã‚ã‚‹ã‹ã€ä¾¡æ ¼å¸¯ã‚’åºƒã’ã¦å†æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚</p>
          <div class="error-box" style="display:${errorLog.length?'block':'none'}">
            å†…éƒ¨ãƒ­ã‚°ï¼ˆå…ˆé ­ã®ã¿ï¼‰:<br>${errorLog.slice(0,2).join('\n\n')}
          </div>
          <div class="mini" style="margin-top:8px;">è©¦è¡Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å€™è£œï¼š</div>
          <div>${candidates.map(c=>`<span class="chip">${c}</span>`).join('')}</div>
        `;
        return;
      }

      mount.innerHTML = `
        <h2 class="section-title">æ¥½å¤©ã®å€™è£œï¼ˆ${found.count}ä»¶ï¼‰</h2>
        <div class="mini" style="margin:-6px 0 10px;">ä½¿ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼š<code>${used}</code>${(minPrice||maxPrice)?` ï¼ ä¾¡æ ¼å¸¯: <code>${minPrice||0}ã€œ${maxPrice||'ä¸Šé™ãªã—'}</code>`:''}</div>
        <div class="items-grid">
          ${found.items.map(x=>`
            <article class="card item-card">
              <img src="${x.image || 'images/diagnosis.jpg'}" alt="${x.name}">
              <div class="card-body">
                <h3>${x.name}</h3>
                <p class="mini">${x.shop}</p>
                <p><strong>Â¥${Number(x.price).toLocaleString()}</strong></p>
                <a class="btn link" target="_blank" href="${x.url}">å•†å“ãƒšãƒ¼ã‚¸ã¸</a>
              </div>
            </article>
          `).join('')}
        </div>
      `;
    }

    /* ===== ãƒªãƒ³ã‚¯æ¤œç´¢ï¼ˆAmazon/æ¥½å¤©ç­‰ï¼‰â€”ç°¡æ˜“ç‰ˆ ===== */
    function providerLinks(type, lenRange, liters){
      const enc=encodeURIComponent;
      const t = normalizeTypeForQuery(type);
      const {feet,inches}=toFeetInches((lenRange[0]+lenRange[1])/2);
      const qMain = `ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰ ${t} ${feet}'${inches}" ${liters}L -ãƒªãƒ¼ã‚·ãƒ¥ -ã‚±ãƒ¼ã‚¹`;
      const qAlt = `ã‚µãƒ¼ãƒ•ãƒœãƒ¼ãƒ‰ ${t}`;
      return [
        { name:'Amazon', urls:[{label:'æ¤œç´¢',url:`https://www.amazon.co.jp/s?k=${enc(qMain)}`},{label:'ä»£æ›¿',url:`https://www.amazon.co.jp/s?k=${enc(qAlt)}`}]},
        { name:'æ¥½å¤©(ã‚µã‚¤ãƒˆå†…æ¤œç´¢)',   urls:[{label:'æ¤œç´¢',url:`https://search.rakuten.co.jp/search/mall/${enc(qMain)}/?st=t&f=0`},{label:'ä»£æ›¿',url:`https://search.rakuten.co.jp/search/mall/${enc(qAlt)}/?st=t&f=0`} ]},
        { name:'ãƒ¡ãƒ«ã‚«ãƒª', urls:[{label:'æ¤œç´¢',url:`https://www.mercari.com/jp/search/?keyword=${enc(qMain)}`},{label:'ä»£æ›¿',url:`https://www.mercari.com/jp/search/?keyword=${enc(qAlt)}`} ]},
        { name:'ãƒ¤ãƒ•ã‚ªã‚¯', urls:[{label:'æ¤œç´¢',url:`https://auctions.yahoo.co.jp/search/search?p=${enc(qMain)}&n=50&exflg=1`},{label:'ä»£æ›¿',url:`https://auctions.yahoo.co.jp/search/search?p=${enc(qAlt)}&n=50&exflg=1`} ]},
      ];
    }

    /* ===== ãƒ¡ã‚¤ãƒ³ï¼šè¨ºæ–­ â†’ ãƒªãƒ³ã‚¯ + æ¥½å¤©API ===== */
    function diagnose(){
      const weight = Number(document.getElementById('weight').value || 0);
      const level = document.getElementById('level').value;
      const wave = document.getElementById('wave').value;
      const style = document.getElementById('style').value;
      const fitness = document.getElementById('fitness').value;
      const floatPref = document.getElementById('floatPref').value;
      const minPrice = Number(document.getElementById('minPrice').value || 0);
      const maxPrice = Number(document.getElementById('maxPrice').value || 0);
      const brandBoost = document.getElementById('brandBoost').checked;

      if(!weight || weight < 35){ alert('ä½“é‡(kg)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      const vol = calcVolume(weight, level, fitness, floatPref);
      const board = pickBoardType(level, wave, style);
      const base = sizeTable[board.type] || sizeTable['ãƒŸãƒƒãƒ‰ãƒ¬ãƒ³ã‚°ã‚¹'];
      const sized = adjustByWeightAndWave(base, weight, wave);

      const img = (board.type.includes('ãƒ­ãƒ³ã‚°')) ? 'images/stays.jpg'
                : (board.type.includes('ãƒŸãƒƒãƒ‰')) ? 'images/diagnosis.jpg'
                : 'images/apparel.jpg';

      const links = providerLinks(board.type, sized.len, vol.liters);
      const providersHtml = links.map(p=>`
        <div class="prov-card">
          <h4>${p.name}</h4>
          <div class="prov-links">
            ${p.urls.map(u=>`<a class="btn link" target="_blank" href="${u.url}">${u.label}</a>`).join('')}
          </div>
        </div>
      `).join('');

      const html = `
        <div class="grid">
          <article class="card">
            <img src="${img}" alt="${board.type}">
            <div class="card-body">
              <h3>${board.type}</h3>
              <p>${board.why}</p>
              <p class="mini">â€»æ¥½å¤©APIã¯0ä»¶æ™‚ã«è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§æ¡ä»¶ã‚’ç·©ã‚ã¦å†æ¤œç´¢ã—ã¾ã™ã€‚</p>
            </div>
          </article>

          <div>
            <table class="table">
              <thead><tr><th>é …ç›®</th><th>æ¨å¥¨å€¤ï¼ˆç›®å®‰ï¼‰</th></tr></thead>
              <tbody>
                <tr><td>ä½“é‡</td><td>${weight} kg</td></tr>
                <tr><td>æ¨å¥¨ãƒœãƒªãƒ¥ãƒ¼ãƒ </td><td><strong>${vol.liters}â„“</strong>ï¼ˆç´„${vol.range[0]}ã€œ${vol.range[1]}â„“ï¼‰ <span class="mini">ä¿‚æ•°:${vol.factor.toFixed(2)}</span></td></tr>
                <tr><td>é•·ã•</td><td>${rangeFeetInches(sized.len)} <span class="mini">ï¼ˆ${rangeCm(sized.len)}ï¼‰</span></td></tr>
                <tr><td>å¹…</td><td>${rangeInch(sized.wid)}</td></tr>
                <tr><td>åšã¿</td><td>${rangeInch(sized.thk)}</td></tr>
              </tbody>
            </table>

            <h3 style="margin:12px 0 8px;">ä»–ã‚µã‚¤ãƒˆã§æ¢ã™ï¼ˆãƒªãƒ³ã‚¯æ¤œç´¢ï¼‰</h3>
            <div class="providers">${providersHtml}</div>
          </div>
        </div>
      `;
      document.getElementById('result').innerHTML = html;
      window.scrollTo({ top: document.getElementById('result').offsetTop - 20, behavior: 'smooth' });

      // æ¥½å¤©APIï¼ˆæ®µéšçš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      renderRakuten(board.type, sized.len, vol.liters, { minPrice: minPrice||undefined, maxPrice: maxPrice||undefined, brandBoost });
    }

    // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ & ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆç°¡ç•¥ï¼‰
    document.addEventListener('click', (e)=>{ const head=e.target.closest('.acc-head'); if(head) head.parentElement.classList.toggle('open'); });
    (function(){
      const body=document.body, burger=document.querySelector('.hamburger');
      const mobileNav=document.getElementById('mobileNav'), backdrop=document.getElementById('backdrop');
      const deskDropdown=document.querySelector('.dropdown'), deskBtn=deskDropdown?.querySelector('.dropbtn');
      const closeMobile=()=>{ body.classList.remove('nav-open'); burger?.setAttribute('aria-expanded','false'); };
      burger?.addEventListener('click', (e)=>{ e.stopPropagation(); const willOpen=!body.classList.contains('nav-open');
        document.querySelectorAll('.dropdown.open').forEach(d=>d.classList.remove('open'));
        if(willOpen){ body.classList.add('nav-open'); burger.setAttribute('aria-expanded','true'); } else { closeMobile(); }});
      backdrop?.addEventListener('click', closeMobile);
      mobileNav?.addEventListener('click', (e)=>{ if(e.target.tagName==='A') closeMobile(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMobile(); });
      if(deskDropdown && deskBtn){
        const closeAll=()=>deskDropdown.classList.remove('open');
        deskBtn.addEventListener('click', (e)=>{ e.stopPropagation(); const willOpen=!deskDropdown.classList.contains('open');
          document.querySelectorAll('.dropdown.open').forEach(d=>d.classList.remove('open'));
          if(willOpen) deskDropdown.classList.add('open'); else closeAll(); });
        document.addEventListener('click', (e)=>{ if(!deskDropdown.contains(e.target)) deskDropdown.classList.remove('open'); });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') deskDropdown.classList.remove('open'); });
      }
    })();
  </script>
</body>
</html>
