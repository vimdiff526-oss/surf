<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japan Surf Condition Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Helvetica Neue', Arial, sans-serif; overflow: hidden; }
        #map { height: 100%; width: 100%; background: #e5e5e5; }

        /* 情報パネル */
        #info-panel {
            position: absolute; top: 20px; right: 20px; width: 300px;
            background: rgba(255, 255, 255, 0.98); padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.15); z-index: 1000; display: none;
            backdrop-filter: blur(5px);
            pointer-events: auto; 
        }
        .row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .label { color: #666; font-size: 0.85rem; }
        .val { font-weight: bold; color: #333; text-align: right; font-size: 0.95rem;}
        .sub-val { font-size: 0.8rem; color: #888; font-weight: normal; display: block; }
        
        /* 注釈テキスト */
        .note-text {
            font-size: 0.7rem; color: #999; margin-top: 4px; line-height: 1.2; text-align: right;
        }

        /* 潮回りタグ */
        .tide-tag {
            display: inline-block; padding: 2px 8px; border-radius: 4px; 
            font-size: 0.8rem; color: white; background: #555; margin-right: 5px;
        }
        .tide-trend { font-weight: bold; color: #007bff; font-size: 0.9rem; }
        .tide-trend.down { color: #dc3545; }

        /* タイドグラフ用キャンバス */
        #tide-graph-container {
            margin-top: 5px;
            text-align: center;
            background: linear-gradient(to bottom, #fcfcfc, #f0f8ff);
            border-radius: 8px;
            padding: 10px 0;
            border: 1px solid #e0e0e0;
        }
        canvas { width: 100%; height: 80px; }

        /* マーカー */
        .surf-marker { display: flex; align-items: center; justify-content: center; }
        .wave-circle {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4); transition: transform 0.2s;
        }
        .wave-circle:hover { transform: scale(1.3); cursor: pointer; z-index: 10000; }
        
        .c-calm { background: #3498db; }
        .c-mod { background: #f1c40f; }
        .c-high { background: #e74c3c; }

        /* 風矢印 */
        .wind-arrow-icon {
            display: flex; align-items: center; justify-content: center;
            pointer-events: none; 
        }
        .arrow-svg path {
            animation-name: flow;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }
        @keyframes flow {
            0% { opacity: 0; transform: translateY(8px); }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-8px); }
        }

        #status-bar {
            position: absolute; bottom: 10px; left: 10px; 
            background: rgba(255, 255, 255, 0.9); color: #333; 
            padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold;
            z-index: 3000; pointer-events: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <div id="status-bar">システム起動中...</div>
    <div id="map"></div>
    
    <div id="info-panel">
        <h3 id="p-name" style="margin-top:0; margin-bottom:10px; font-size:1.2rem;">-</h3>
        
        <div class="row" style="border-bottom: none; margin-bottom: 0;">
            <span class="label">波高 (目安)</span>
            <div style="text-align:right;">
                <div id="p-wave-cond" class="val">-</div>
                <div id="p-wave" class="sub-val">- m</div>
            </div>
        </div>
        <div class="note-text" style="margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eee;">
            ※地形や潮回りにより、実際に<br>ブレイクするサイズは前後します
        </div>

        <div class="row">
            <span class="label">うねり</span>
            <div style="text-align:right;">
                <span id="p-swell" class="val">-</span>
            </div>
        </div>

        <div class="row">
            <span class="label">風速</span>
            <div style="text-align:right;">
                <span id="p-wind" class="val">-</span>
                <div id="p-wdir" class="sub-val">-</div>
            </div>
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin: 5px 0 10px 0;">

        <div class="row" style="background: #f9f9f9; padding: 8px; border-radius: 6px; border: none; margin-bottom: 5px;">
            <span class="label">潮回り</span>
            <div style="text-align:right;">
                <div style="margin-bottom:4px;">
                    <span id="p-tide-name" class="tide-tag">-</span>
                    <span id="p-moon-age" style="font-size:0.8rem; color:#999;">(月齢 -)</span>
                </div>
                <div id="p-tide-trend" class="val">-</div>
            </div>
        </div>

        <div id="tide-graph-container">
            <canvas id="tideCanvas" width="280" height="80"></canvas>
            <div style="font-size:0.7rem; color:#999; display:flex; justify-content:space-between; padding:0 10px;">
                <span>0</span><span>6</span><span>12</span><span>18</span><span>24</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        function setStatus(msg) {
            document.getElementById('status-bar').innerText = msg;
        }

        const map = L.map('map', { zoomControl: false }).setView([36.0, 138.0], 5);
        L.control.zoom({ position: 'topleft' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19, attribution: '&copy; CARTO'
        }).addTo(map);

        map.on('click', () => {
            document.getElementById('info-panel').style.display = 'none';
        });
        const panel = document.getElementById('info-panel');
        L.DomEvent.disableClickPropagation(panel);

        const spots = [
            // 北日本
            { name: "北海道 - 浜厚真", lat: 42.60, lon: 141.83 },
            { name: "秋田 - 男鹿", lat: 39.88, lon: 139.85 },
            { name: "宮城 - 仙台新港", lat: 38.278, lon: 141.023 },
            { name: "日本海 - 新潟", lat: 37.90, lon: 139.00 },
            { name: "石川 - 柴垣", lat: 36.90, lon: 136.70 },
            // 茨城・千葉
            { name: "茨城 - 大洗", lat: 36.30, lon: 140.58 },
            { name: "千葉 - 片貝", lat: 35.53, lon: 140.46 },
            { name: "千葉 - 一宮", lat: 35.36, lon: 140.39 },
            { name: "千葉 - 鴨川", lat: 35.11, lon: 140.12 },
            // 湘南・東海
            { name: "湘南 - 鵠沼", lat: 35.31, lon: 139.47 }, 
            { name: "湘南 - 茅ヶ崎", lat: 35.32, lon: 139.41 },
            { name: "湘南 - 吉浜", lat: 35.15, lon: 139.10 },
            { name: "静岡 - 白浜", lat: 34.68, lon: 138.97 },
            { name: "愛知 - 伊良湖", lat: 34.59, lon: 137.08 },
            // 西日本
            { name: "京都 - 八丁浜", lat: 35.68, lon: 135.06 },
            { name: "和歌山 - 磯の浦", lat: 34.260, lon: 135.094 },
            { name: "高知 - 生見", lat: 33.54, lon: 134.29 },
            { name: "宮崎 - 木崎浜", lat: 31.83, lon: 131.43 },
            { name: "沖縄 - 砂辺", lat: 26.33, lon: 127.74 }
        ];

        const windLayerGroup = L.layerGroup().addTo(map);

        function getDirText(deg) {
            const dirs = ['北', '北東', '東', '南東', '南', '南西', '西', '北西'];
            return dirs[Math.round(deg / 45) % 8];
        }

        // 波サイズ表記
        function getSurfConditionText(height) {
            if (height < 0.35) return "スネ 〜 ひざ前後"; 
            if (height < 0.7)  return "ひざ 〜 腰";
            if (height < 1.1)  return "腰 〜 腹";
            if (height < 1.6)  return "腹 〜 胸";
            if (height < 2.2)  return "胸 〜 頭";
            return "頭オーバー"; 
        }

        // 潮汐計算
        function getTideInfo() {
            const now = new Date();
            const knownNewMoon = new Date(2024, 0, 11, 20, 57); 
            const cycle = 29.53059;
            const diffTime = now.getTime() - knownNewMoon.getTime();
            const diffDays = diffTime / (1000 * 60 * 60 * 24);
            let moonAge = diffDays % cycle;
            if (moonAge < 0) moonAge += cycle;

            const ageInt = Math.floor(moonAge);
            let name = "中潮";
            
            if (ageInt >= 0 && ageInt <= 2) name = "大潮";
            else if (ageInt >= 3 && ageInt <= 6) name = "中潮";
            else if (ageInt >= 7 && ageInt <= 9) name = "小潮";
            else if (ageInt == 10) name = "長潮";
            else if (ageInt >= 11 && ageInt <= 13) name = "若潮";
            else if (ageInt >= 14 && ageInt <= 16) name = "大潮";
            else if (ageInt >= 17 && ageInt <= 21) name = "中潮";
            else if (ageInt >= 22 && ageInt <= 23) name = "小潮";
            else if (ageInt == 24) name = "長潮";
            else if (ageInt >= 25) name = "若潮";
            if (ageInt >= 29) name = "大潮";

            const highTide1 = (moonAge * 0.8) % 24;
            const highTide2 = (highTide1 + 12.4) % 24;
            
            const currentHour = now.getHours() + now.getMinutes()/60;
            let targetHT = highTide1;
            if (Math.abs(currentHour - highTide2) < Math.abs(currentHour - highTide1)) targetHT = highTide2;
            if (Math.abs(currentHour - (highTide1 + 24)) < Math.abs(currentHour - targetHT)) targetHT = highTide1 + 24;
            if (Math.abs(currentHour - (highTide2 - 24)) < Math.abs(currentHour - targetHT)) targetHT = highTide2 - 24;

            const diff = targetHT - currentHour;
            let trendText = "", trendClass = "";

            if (diff > 0) {
                if (diff < 1.5) { trendText = "満潮付近"; trendClass = "tide-trend"; }
                else { trendText = "上げ潮 ↗"; trendClass = "tide-trend"; }
            } else {
                if (Math.abs(diff) < 1.5) { trendText = "満潮付近"; trendClass = "tide-trend down"; }
                else { trendText = "下げ潮 ↘"; trendClass = "tide-trend down"; }
            }

            return { name, moonAge: moonAge.toFixed(1), trendText, trendClass, highTide1 };
        }

        // タイドグラフ描画
        function drawTideGraph(tideInfo) {
            const canvas = document.getElementById('tideCanvas');
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;

            ctx.clearRect(0, 0, w, h);

            const gradient = ctx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, "rgba(52, 152, 219, 0.6)");
            gradient.addColorStop(1, "rgba(52, 152, 219, 0.05)");

            const ht = tideInfo.highTide1;
            
            ctx.beginPath();
            ctx.moveTo(0, h);

            for (let x = 0; x <= w; x++) {
                const time = (x / w) * 24;
                const wave = Math.cos(2 * Math.PI * (time - ht) / 12.4);
                const y = (h / 2) + (wave * -1 * (h * 0.35));
                ctx.lineTo(x, y);
            }

            ctx.lineTo(w, h);
            ctx.closePath();
            ctx.fillStyle = gradient;
            ctx.fill();
            ctx.strokeStyle = "#3498db";
            ctx.lineWidth = 2;
            ctx.stroke();

            const now = new Date();
            const currentH = now.getHours() + now.getMinutes() / 60;
            const currentX = (currentH / 24) * w;

            ctx.beginPath();
            ctx.moveTo(currentX, 0);
            ctx.lineTo(currentX, h);
            ctx.strokeStyle = "rgba(231, 76, 60, 0.8)";
            ctx.lineWidth = 1.5;
            ctx.setLineDash([4, 2]);
            ctx.stroke();
            ctx.setLineDash([]);

            const currentWave = Math.cos(2 * Math.PI * (currentH - ht) / 12.4);
            const currentY = (h / 2) + (currentWave * -1 * (h * 0.35));
            
            ctx.beginPath();
            ctx.arc(currentX, currentY, 5, 0, Math.PI * 2);
            ctx.fillStyle = "#e74c3c";
            ctx.fill();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        async function init() {
            setStatus("気象データ取得中...");
            
            try {
                const lats = spots.map(s => s.lat).join(',');
                const lons = spots.map(s => s.lon).join(',');
                
                const mUrl = `https://marine-api.open-meteo.com/v1/marine?latitude=${lats}&longitude=${lons}&current=wave_height,swell_wave_direction&timezone=Asia%2FTokyo`;
                const wUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lats}&longitude=${lons}&current=wind_speed_10m,wind_direction_10m&wind_speed_unit=ms`;

                const [mRes, wRes] = await Promise.all([
                    fetch(mUrl).then(r => r.json()),
                    fetch(wUrl).then(r => r.json())
                ]);

                setStatus("マップ描画中...");

                const mData = Array.isArray(mRes) ? mRes : [mRes];
                const wData = Array.isArray(wRes) ? wRes : [wRes];
                const windVectors = [];
                
                const tideInfo = getTideInfo();

                spots.forEach((spot, i) => {
                    if(!mData[i] || !mData[i].current || !wData[i] || !wData[i].current) return;

                    const wh = mData[i].current.wave_height || 0;
                    const swellDir = mData[i].current.swell_wave_direction || 0;
                    const ws = wData[i].current.wind_speed_10m || 0;
                    const wd = wData[i].current.wind_direction_10m || 0;

                    let cClass = 'c-calm';
                    if(wh >= 0.5) cClass = 'c-mod';
                    if(wh >= 1.5) cClass = 'c-high';

                    const icon = L.divIcon({
                        className: 'custom-div',
                        html: `<div class="surf-marker"><div class="wave-circle ${cClass}"></div></div>`,
                        iconSize: [24, 24]
                    });

                    const marker = L.marker([spot.lat, spot.lon], {icon: icon, zIndexOffset: 1000}).addTo(map);
                    
                    marker.on('click', (e) => {
                        L.DomEvent.stopPropagation(e);
                        const panel = document.getElementById('info-panel');
                        document.getElementById('p-name').innerText = spot.name;
                        
                        document.getElementById('p-wave-cond').innerText = getSurfConditionText(wh);
                        document.getElementById('p-wave').innerText = `${wh.toFixed(2)} m`;
                        document.getElementById('p-swell').innerText = `${getDirText(swellDir)} (${Math.round(swellDir)}°)`;
                        document.getElementById('p-wind').innerText = `${ws.toFixed(1)} m/s`;
                        document.getElementById('p-wdir').innerText = `${getDirText(wd)} (${Math.round(wd)}°)`;

                        document.getElementById('p-tide-name').innerText = tideInfo.name;
                        const trendEl = document.getElementById('p-tide-trend');
                        trendEl.innerText = tideInfo.trendText;
                        trendEl.className = `val ${tideInfo.trendClass}`;
                        
                        drawTideGraph(tideInfo);
                        
                        panel.style.display = 'block';
                    });

                    const rad = wd * (Math.PI / 180);
                    windVectors.push({
                        lat: spot.lat, lon: spot.lon,
                        u: -ws * Math.sin(rad),
                        v: -ws * Math.cos(rad),
                        speed: ws
                    });
                });

                drawAnimatedWind(windVectors);
                setStatus("表示完了");

            } catch(e) {
                console.error(e);
                setStatus("データ取得エラー");
            }
        }

        function drawAnimatedWind(vectors) {
            windLayerGroup.clearLayers();
            const gridStep = 0.7; 
            const latTop = 46.0, latBottom = 24.0;
            const lonLeft = 122.0, lonRight = 148.0;

            for(let lat = latTop; lat >= latBottom; lat -= gridStep) {
                for(let lon = lonLeft; lon <= lonRight; lon += gridStep) {
                    let sumU = 0, sumV = 0, sumW = 0;
                    let minDistance = 9999;
                    for(const vec of vectors) {
                        const d2 = Math.pow(lat - vec.lat, 2) + Math.pow(lon - vec.lon, 2);
                        const d = Math.sqrt(d2);
                        if(d < minDistance) minDistance = d;
                        const w = 1.0 / (d2 + 0.05); 
                        sumU += vec.u * w;
                        sumV += vec.v * w;
                        sumW += w;
                    }
                    if(minDistance > 4.5) continue;
                    if(sumW > 0) {
                        const u = sumU / sumW;
                        const v = sumV / sumW;
                        const speed = Math.sqrt(u*u + v*v);
                        let degree = (Math.atan2(-u, -v) * 180 / Math.PI) + 180; 
                        addAnimatedArrow(lat, lon, degree, speed);
                    }
                }
            }
        }

        function addAnimatedArrow(lat, lon, degree, speed) {
            let scale = 0.8;
            let opacity = 0.5;
            if(speed > 5) { scale = 1.0; opacity = 0.7; }
            if(speed > 10) { scale = 1.2; opacity = 0.9; }
            let animDuration = Math.max(0.5, 2.0 - (speed * 0.1));
            let animDelay = -Math.random() * 2;
            const svgArrow = `
                <svg width="30" height="30" viewBox="0 0 24 24" class="arrow-svg" style="transform: rotate(${degree}deg) scale(${scale}); opacity: ${opacity};">
                    <path d="M12 2 L6 18 L12 14 L18 18 Z" fill="#555" stroke="none" style="animation-duration: ${animDuration}s; animation-delay: ${animDelay}s;"/>
                </svg>
            `;
            const icon = L.divIcon({
                className: 'wind-arrow-icon',
                html: svgArrow,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            L.marker([lat, lon], { icon: icon, interactive: false, zIndexOffset: -100 }).addTo(windLayerGroup);
        }

        init();
    </script>
</body>
</html>